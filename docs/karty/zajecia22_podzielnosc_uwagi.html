<!DOCTYPE html>

<html lang="pl">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>ZajÄ™cia 22 â€“ PodzielnoÅ›Ä‡ uwagi (zadanie podwÃ³jne)</title>
<style>
  :root { --scale: 1.0; --accent:#F7B801; }
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#000; color:#fff; font-size:calc(18px * var(--scale)); }
  .wrap { max-width: 1100px; margin: 0 auto; padding: 20px; }
  h1 { font-size: calc(2rem * var(--scale)); margin: 0 0 8px; }
  .note { font-size: calc(1rem * var(--scale)); color:#ffe9a8; }
  .controls { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; margin: 12px 0; }
  label { display:block; margin-bottom:6px; }
  input[type="number"], input[type="range"], select, button { width:100%; padding:12px 14px; font-size:calc(1rem * var(--scale)); background:#000; color:#fff; border:2px solid var(--accent); border-radius:12px; }
  button.primary { background:var(--accent); color:#000; border-color:var(--accent); font-weight:800; cursor:pointer; }
  .panel { border:2px solid var(--accent); border-radius:16px; background:#111; padding:16px; margin-bottom:14px; }
  .display { border:3px dashed var(--accent); border-radius:16px; min-height: 34vh; padding:16px; position:relative; overflow:hidden; }
  .center { display:flex; align-items:center; justify-content:center; height: 180px; }
  .letter { font-size: calc(5rem * var(--scale)); font-weight:900; letter-spacing:.5px; }
  .periph { position:absolute; width: 44px; height: 44px; border-radius:50%; background:#F7B801; box-shadow:0 0 12px rgba(247,184,1,.7); opacity:0; }
  .periph.on { opacity: 1; }
  .legend { display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
  .pill { min-width:58px; padding:8px 12px; border:2px solid var(--accent); border-radius:999px; font-weight:900; background:#000; color:#fff; display:inline-flex; align-items:center; gap:8px; }
  .key { display:inline-flex; min-width:36px; justify-content:center; padding:6px 10px; border:2px solid var(--accent); border-radius:8px; font-weight:800; }
  .stats { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:10px; margin-top:12px; }
  .stat { background:#111; border:1px solid #333; border-radius:12px; padding:10px; color:#ddd; }
</style>
</head>
<body>
<main class="wrap">
<h1>ðŸ§­ ZajÄ™cia 22 â€“ PodzielnoÅ›Ä‡ uwagi (zadanie podwÃ³jne)</h1>
<p class="note">
      Zadanie A (centrum): naciskaj <span class="key">J</span>, gdy pojawi siÄ™ litera <b>T</b> lub <b>L</b>.<br/>
      Zadanie B (peryferia): naciskaj <span class="key">SPACJÄ˜</span>, gdy zapali siÄ™ Å¼Ã³Å‚te kÃ³Å‚ko na brzegu ekranu.
    </p>
<section class="panel">
<div class="controls">
<div><label>WielkoÅ›Ä‡: <span id="fontVal">100%</span></label><input id="fontsize" max="220" min="80" step="5" type="range" value="100"/></div>
<div><label>Kontrast</label><select id="theme"><option value="dark">Ciemny</option><option value="light">Jasny</option></select></div>
<div><label>Lektor</label><select id="tts"><option selected="" value="on">WÅ‚Ä…czony</option><option value="off">WyÅ‚Ä…czony</option></select></div>
<div><label>Liczba bodÅºcÃ³w</label><input id="rounds" max="300" min="30" type="number" value="120"/></div>
<div><label>Tempo (ms/zmiana)</label><input id="tempo" max="2000" min="350" step="50" type="number" value="800"/></div>
<div><label>Szansa litery docelowej (%)</label><input id="pTarget" max="60" min="5" step="5" type="number" value="25"/></div>
<div><label>Szansa bodÅºca peryferyjnego (%)</label><input id="pPeriph" max="40" min="5" step="5" type="number" value="20"/></div>
<div style="align-self:end"><button class="primary" id="start">START</button></div>
</div>
<div aria-live="polite" class="display" id="disp">
<div class="center"><div class="letter" id="letter">START</div></div>
<div class="periph" id="p1" style="left:12px; top:12px;"></div>
<div class="periph" id="p2" style="right:12px; top:12px;"></div>
<div class="periph" id="p3" style="left:12px; bottom:12px;"></div>
<div class="periph" id="p4" style="right:12px; bottom:12px;"></div>
<div aria-hidden="true" class="legend">
<span class="pill"><span class="key">J</span> Litera T/L</span>
<span class="pill"><span class="key">SPACJA</span> Å»Ã³Å‚te kÃ³Å‚ko</span>
</div>
</div>
<div class="stats">
<div class="stat"><b>BodÅºce:</b> <span id="n">0 / 0</span></div>
<div class="stat"><b>Zad. A â€“ trafienia:</b> <span id="aHit">0</span></div>
<div class="stat"><b>Zad. A â€“ bÅ‚Ä™dy:</b> <span id="aErr">0</span></div>
<div class="stat"><b>Zad. B â€“ trafienia:</b> <span id="bHit">0</span></div>
<div class="stat"><b>Zad. B â€“ bÅ‚Ä™dy:</b> <span id="bErr">0</span></div>
<div class="stat"><b>RT (A) Å›r.:</b> <span id="aAvg">â€”</span></div>
<div class="stat"><b>RT (B) Å›r.:</b> <span id="bAvg">â€”</span></div>
</div>
</section>
</main>
<script>
// UI helpers
const $ = (s)=>document.querySelector(s);
const el = {
  start: $('#start'), disp: $('#disp'), letter: $('#letter'),
  rounds: $('#rounds'), tempo: $('#tempo'), pTarget: $('#pTarget'), pPeriph: $('#pPeriph'),
  n: $('#n'), aHit: $('#aHit'), aErr: $('#aErr'), bHit: $('#bHit'), bErr: $('#bErr'),
  aAvg: $('#aAvg'), bAvg: $('#bAvg'), fontsize: $('#fontsize'), fontVal: $('#fontVal'), theme: $('#theme'), tts: $('#tts'),
  p1: $('#p1'), p2: $('#p2'), p3: $('#p3'), p4: $('#p4')
};

let voiceOn = true;
el.tts.addEventListener('change', (e)=>{ voiceOn = e.target.value==='on'; if(!voiceOn && 'speechSynthesis' in window) window.speechSynthesis.cancel(); });
function say(txt){ if(!voiceOn) return; if(!('speechSynthesis' in window)) return; const u=new SpeechSynthesisUtterance(txt); u.lang='pl-PL'; u.rate=0.95; window.speechSynthesis.cancel(); window.speechSynthesis.speak(u); }

el.fontsize.addEventListener('input', ()=>{ const v=parseInt(el.fontsize.value,10); el.fontVal.textContent=v+'%'; document.documentElement.style.setProperty('--scale', (v/100)); });
el.theme.addEventListener('change', (e)=>{ const v=e.target.value; document.body.style.background = v==='light' ? '#fff' : '#000'; document.body.style.color = v==='light' ? '#000' : '#F7B801'; document.querySelectorAll('.panel,input,select,button,.display,.pill,.key').forEach(elm=>{ elm.style.borderColor = v==='light' ? '#000' : getComputedStyle(document.documentElement).getPropertyValue('--accent'); }); });

// Task state
const LETTERS = ['A','E','F','H','K','M','N','R','S','U','V','W','Y','T','L']; // T/L jako cele
const PERIPHS = [el.p1, el.p2, el.p3, el.p4];

const st = {
  total:120, i:0, timer:0, tempo:800,
  aAns:false, bAns:false, aT0:0, bT0:0,
  aHit:0, aErr:0, bHit:0, bErr:0, aRT:[], bRT:[],
  periphOn:null
};

function resetStats(){
  st.i=0; st.aHit=0; st.aErr=0; st.bHit=0; st.bErr=0; st.aRT=[]; st.bRT=[];
  el.aHit.textContent='0'; el.aErr.textContent='0'; el.bHit.textContent='0'; el.bErr.textContent='0'; el.aAvg.textContent='â€”'; el.bAvg.textContent='â€”';
}

function avg(arr){ return arr.length? Math.round(arr.reduce((a,b)=>a+b,0)/arr.length) : null; }

function next(){
  clearTimeout(st.timer);
  st.i++; el.n.textContent = `${Math.min(st.i, st.total)} / ${st.total}`;
  if(st.i>st.total){ finish(); return; }

  // Generate new central letter
  const pT = parseInt(el.pTarget.value)||25;
  const isTarget = (Math.random()*100 < pT);
  const pool = LETTERS;
  let letter = pool[Math.floor(Math.random()*pool.length)];
  if(isTarget){ letter = Math.random()<0.5 ? 'T' : 'L'; }
  else { while(letter==='T' || letter==='L') letter = pool[Math.floor(Math.random()*pool.length)]; }
  el.letter.textContent = letter;
  st.aAns = (letter==='T' || letter==='L'); st.aT0 = performance.now();

  // Maybe spawn peripheral
  PERIPHS.forEach(p=>p.classList.remove('on'));
  st.periphOn = null; st.bAns=false;
  if(Math.random()*100 < (parseInt(el.pPeriph.value)||20)){
    const p = PERIPHS[Math.floor(Math.random()*PERIPHS.length)];
    p.classList.add('on'); st.periphOn = p; st.bAns = true; st.bT0 = performance.now();
  }

  st.tempo = parseInt(el.tempo.value)||800;
  st.timer = setTimeout(()=>{ // time window closes -> count misses for active targets
    // Central task miss is simply no response; we don't track miss separately, tylko bÅ‚Ä™dy (fa) gdy zbÄ™dna reakcja
    if(st.periphOn){ st.periphOn.classList.remove('on'); st.periphOn=null; }
    next();
  }, st.tempo);
}

function pressA(){
  // J pressed for letter T/L
  if(st.aAns){ st.aHit++; el.aHit.textContent=st.aHit; const rt=Math.max(0, performance.now()-st.aT0); st.aRT.push(rt); }
  else { st.aErr++; el.aErr.textContent=st.aErr; }
  const a=avg(st.aRT); if(a!==null) el.aAvg.textContent=a+' ms';
}
function pressB(){
  // Space for peripheral
  if(st.bAns && st.periphOn){ st.bHit++; el.bHit.textContent=st.bHit; const rt=Math.max(0, performance.now()-st.bT0); st.bRT.push(rt); st.periphOn.classList.remove('on'); st.periphOn=null; }
  else { st.bErr++; el.bErr.textContent=st.bErr; }
  const b=avg(st.bRT); if(b!==null) el.bAvg.textContent=b+' ms';
}

function start(){
  st.total = parseInt(el.rounds.value)||120;
  resetStats();
  say('Zadanie podzielnoÅ›ci uwagi. Reaguj na literÄ™ T lub L oraz na Å¼Ã³Å‚te kÃ³Å‚ko w naroÅ¼nikach.');
  next();
}

el.start.addEventListener('click', start);
window.addEventListener('keydown', (e)=>{
  if(['INPUT','SELECT','TEXTAREA','BUTTON'].includes(document.activeElement?.tagName)) return;
  if(e.key.toLowerCase()==='j'){ e.preventDefault(); pressA(); }
  if(e.code==='Space'){ e.preventDefault(); pressB(); }
});
</script>
<div class="injected-counters" style="position:fixed;left:12px;bottom:12px;z-index:9999;background:#070707;padding:8px;border-radius:10px;border:2px solid #222;color:#fff;font-weight:800">Poprawne: <span class="fix22-counter" id="injected_good22">0</span> Â  BÅ‚Ä™dne: <span class="fix22-counter" id="injected_bad22">0</span> Â  KlikniÄ™cia: <span class="fix22-counter" id="injected_total22">0</span></div><script data-injected="fix22_v3">
// injected fix22_v3: count TOTAL clicks, GOOD and ERRORS; reset on 'new task' click
(function(){
  // helper selectors
  function $(sel){ return document.querySelector(sel); }
  function $all(sel){ return Array.prototype.slice.call(document.querySelectorAll(sel)); }

  // locate left/right elements heuristically (same logic as before)
  var left = document.querySelector('[data-side="left"], .left, .box-left, .leftBox, .choice-left') || null;
  var right = document.querySelector('[data-side="right"], .right, .box-right, .rightBox, .choice-right') || null;

  if(!left || !right){
    var clickables = $all('button, [role="button"], .box, .cell, .square, .option').filter(function(el){ return el.offsetWidth>40 && el.offsetHeight>30; });
    if(clickables.length>=2){
      left = left || clickables[0];
      right = right || clickables[1];
    } else {
      var container = document.getElementById('choices') || document.getElementById('board') || document.getElementById('board22') || document.querySelector('.board');
      if(container){
        var nodes = Array.prototype.slice.call(container.querySelectorAll('div,button'));
        if(nodes.length>=2){ left = left || nodes[0]; right = right || nodes[1]; }
      }
    }
  }

  // create fallback boxes if needed
  var created = false;
  if(!left || !right){
    created = true;
    var wrapper = document.createElement('div');
    wrapper.style.cssText = 'position:fixed;right:12px;bottom:12px;display:flex;gap:8px;z-index:9999';
    left = document.createElement('div'); left.textContent='Lewo (J)'; left.tabIndex=0;
    right = document.createElement('div'); right.textContent='Prawo (Spacja)'; right.tabIndex=0;
    [left,right].forEach(function(el){ el.className='injected-fallback-box'; el.style.cssText='background:#0f0f0f;color:#fff;padding:10px 14px;border-radius:10px;border:2px solid #00E0FF;cursor:pointer;font-weight:900'; });
    wrapper.appendChild(left); wrapper.appendChild(right);
    document.body.appendChild(wrapper);
  }

  left.setAttribute('data-injected-side','left');
  right.setAttribute('data-injected-side','right');

  // counters
  var totalEl = document.getElementById('injected_total22');
  var badEl = document.getElementById('injected_bad22');
  var goodEl = document.getElementById('injected_good22');
  if(!totalEl || !badEl || !goodEl){
    var container = document.querySelector('.injected-counters');
    if(!container){
      container = document.createElement('div');
      container.className='injected-counters';
      container.style.cssText='position:fixed;left:12px;bottom:12px;z-index:9999;background:#070707;padding:8px;border-radius:10px;border:2px solid #222;color:#fff;font-weight:800';
      document.body.appendChild(container);
    }
    container.innerHTML = 'Poprawne: <span id="injected_good22" class="fix22-counter">0</span> &nbsp; BÅ‚Ä™dne: <span id="injected_bad22" class="fix22-counter">0</span> &nbsp; KlikniÄ™cia: <span id="injected_total22" class="fix22-counter">0</span>';
    totalEl = document.getElementById('injected_total22');
    badEl = document.getElementById('injected_bad22');
    goodEl = document.getElementById('injected_good22');
  }

  var total=0, bad=0, good=0;

  // central click handler: counts any click on interactive targets
  function onInteractiveClick(target){
    if(!target) return;
    total++; totalEl.textContent = total;
    // determine correctness: prefer explicit attributes/classes
    var isCorrect = false;
    try{
      if(target.hasAttribute && target.hasAttribute('data-correct')) isCorrect = true;
      if(target.classList && target.classList.contains('correct')) isCorrect = true;
      if(target.getAttribute && target.getAttribute('aria-checked')==='true') isCorrect = true;
      // if parent container has data-correct-side and target position indicates side, try to infer
      var anc = target.closest('[data-correct-side]');
      if(!isCorrect && anc){
        var cs = anc.getAttribute('data-correct-side');
        if(cs){
          // if cs equals 'left' or 'right' set correctness if target is on that side
          var rect = target.getBoundingClientRect();
          var mid = window.innerWidth/2;
          var side = (rect.left + rect.width/2) < mid ? 'left' : 'right';
          if(side === cs.toLowerCase()) isCorrect = true;
        }
      }
    }catch(e){ /* ignore */ }

    if(isCorrect){
      good++; goodEl.textContent = good;
      try{ target.classList.add('fix22-ok'); setTimeout(function(){ target.classList.remove('fix22-ok'); },500); }catch(e){};
    } else {
      bad++; badEl.textContent = bad;
      try{ target.classList.add('fix22-bad'); setTimeout(function(){ target.classList.remove('fix22-bad'); },700); }catch(e){};
    }
  }

  // delegated listener to capture clicks on interactive elements
  document.addEventListener('click', function(e){
    var tgt = e.target.closest('button,[role="button"],.cell,.square,.option,.item,div[data-injected-side],.injected-fallback-box');
    if(!tgt) return;
    // ignore clicks on the counters container or the helper UI itself
    if(tgt.closest('.injected-counters') || tgt.classList.contains('injected-counters')) return;
    onInteractiveClick(tgt);
  }, true);

  // keyboard handlers mapping
  document.addEventListener('keydown', function(e){
    var active = document.activeElement;
    if(active && (active.tagName==='INPUT' || active.tagName==='TEXTAREA' || active.isContentEditable)) return;
    var k = e.key.toLowerCase();
    if(k === 'j'){
      e.preventDefault();
      left.classList.add('fix22-flash'); setTimeout(function(){ left.classList.remove('fix22-flash'); },700);
      onInteractiveClick(left);
    } else if(e.code === 'Space' || k === ' '){
      e.preventDefault();
      right.classList.add('fix22-flash'); setTimeout(function(){ right.classList.remove('fix22-flash'); },700);
      onInteractiveClick(right);
    }
  }, true);

  // hook New Task: find original new button(s) and attach reset behavior
  function hookNewTask(){
    var btn = document.querySelector('#new22, button[data-action="new"], .new-task, button.replay, button.reset');
    if(!btn){
      // try to find a button with label 'Nowe' in the page
      var allBtns = Array.prototype.slice.call(document.querySelectorAll('button'));
      for(var i=0;i<allBtns.length;i++){
        if(/nowe/i.test(allBtns[i].textContent)) { btn = allBtns[i]; break; }
      }
    }
    if(!btn){
      // if still not found, create a small new task button near counters
      var container = document.querySelector('.injected-counters');
      var b = document.createElement('button'); b.textContent='Nowe zadanie'; b.className='btn-injected';
      b.style.cssText='margin-left:8px;padding:6px 8px;border-radius:8px;background:#111;border:2px solid #333;color:#fff;cursor:pointer';
      container.appendChild(b);
      btn = b;
    }
    btn.addEventListener('click', function(){
      // attempt to trigger original new task if exists
      var orig = document.querySelector('#new22, button[data-action="new"], .new-task');
      if(orig && orig !== btn){
        try{ orig.click(); }catch(e){}
      }
      // reset counters
      total = 0; bad = 0; good = 0;
      totalEl.textContent = '0'; badEl.textContent = '0'; goodEl.textContent = '0';
      // flash a side as visual cue
      var chosen = Math.random() < 0.5 ? left : right;
      chosen.classList.add('fix22-flash');
      setTimeout(function(){ chosen.classList.remove('fix22-flash'); }, 900);
      // remove outlines from interactive elements to reset UI
      try{
        $all('.fix22-ok, .fix22-bad').forEach(function(el){ el.classList.remove('fix22-ok'); el.classList.remove('fix22-bad'); el.style.outline=''; });
      }catch(e){}
    });
  }
  hookNewTask();

  // marker
  var m = document.createElement('div'); m.id='injected_fix22_v3'; m.style.display='none'; document.body.appendChild(m);

  // announce keys hint
  var hint = document.createElement('div'); hint.setAttribute('data-injected','fix22'); hint.style.cssText='position:fixed;left:12px;top:12px;background:#070707;color:#fff;padding:6px 8px;border-radius:8px;border:2px solid #222;z-index:9999;font-weight:800';
  hint.textContent = 'Klawisze: J (lewy), Spacja (prawy)';
  document.body.appendChild(hint);

})(); 
</script></body>
</html>
