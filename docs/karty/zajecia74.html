<!DOCTYPE html><html lang="pl"><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Zajęcia 74 – Pamięć słuchowa (kierunki) – naprawiony TTS</title>
<style>
:root{--accent:#00E0FF;--rad:14px}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#000;color:#fff}
.wrap{max-width:1100px;margin:0 auto;padding:16px}
h1{margin:0 0 8px;color:var(--accent);font-weight:900}
.panel{border:2px solid var(--accent);border-radius:var(--rad);background:#0e0e0e;padding:12px;margin:10px 0;overflow:hidden}
.controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;align-items:end}
label{display:block;margin-bottom:6px}
select,button,input{padding:10px 12px;background:#000;color:#fff;border:2px solid var(--accent);border-radius:12px;font-weight:800}
button.primary{background:var(--accent);color:#000;border-color:var(--accent);cursor:pointer}
.small{font-size:1rem;color:#ddd;margin:4px 0 0}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:10px}
.stat{background:#0b0b0b;border:1px solid #333;border-radius:12px;padding:8px;color:#ddd}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:center}
.bad{outline:3px solid #f44}
.good{outline:3px solid #0f8}
</style></head><body><main class="wrap">
<h1>🎧 Zajęcia 74 – Pamięć słuchowa (TTS FIX)</h1>
<section class="panel">
  <div class="controls">
    <div>
      <label for="pace">Tempo podawania</label>
      <select id="pace">
        <option value="slow">wolne</option>
        <option value="normal" selected>normalne</option>
        <option value="fast">szybkie</option>
      </select>
    </div>
    <div class="row">
      <button class="primary" id="start">START</button>
      <button class="primary" id="repeat">🔊 Powtórz sekwencję</button>
      <button class="primary" id="unlock">🔈 Aktywuj głos</button>
    </div>
  </div>
  <p class="small">Po wciśnięciu <b>START</b> usłyszysz sekwencję słów <i>lewo/prawo/góra/dół</i>. Kliknij przyciski w tej samej kolejności. Jeśli nie słychać głosu, kliknij <b>Aktywuj głos</b> (wymagana pierwsza interakcja w przeglądarce).</p>
</section>
<section class="panel" style="text-align:center">
  <div class="row" id="buttons" style="margin-top:12px"></div>
  <div class="stats"><div class="stat"><b>Długość sekwencji:</b> <span id="len">–</span></div><div class="stat"><b>Poprawnie rund:</b> <span id="ok">0</span></div><div class="stat"><b>Błędy:</b> <span id="err">0</span></div></div>
</section>
<script>
// --- TTS ROBUST ---
let synth = ('speechSynthesis' in window) ? window.speechSynthesis : null;
let ttsVoice = null; let ttsReady = false;
function chooseVoice(){
  if(!synth) return;
  const voices = synth.getVoices ? synth.getVoices() : [];
  ttsVoice = voices.find(v => v.lang && v.lang.toLowerCase().startsWith('pl')) ||
             voices.find(v => /pol/i.test(v.name||'')) ||
             voices[0] || null;
  ttsReady = true;
}
if(synth){
  chooseVoice();
  if(synth.onvoiceschanged !== undefined) synth.onvoiceschanged = chooseVoice;
}
function say(text, rateAdj=0) {
  if(!synth) return;
  try{ synth.cancel(); }catch(e){}
  const u = new SpeechSynthesisUtterance(text);
  if(ttsVoice) u.voice = ttsVoice;
  u.lang = (ttsVoice && ttsVoice.lang) ? ttsVoice.lang : 'pl-PL';
  u.rate = 1 + rateAdj; u.pitch = 1; u.volume = 1;
  synth.speak(u);
  return u;
}
function unlockTTS(){
  if(!synth) return;
  chooseVoice();
  const u = say('Głos aktywowany', 0);
}
// --- GRA ---
const dirs = ['lewo','prawo','góra','dół'];
let seq=[], pos=0, ok=0, err=0, playing=false;
function buttons(){
  const wrap=document.getElementById('buttons'); wrap.innerHTML='';
  dirs.forEach(d=>{ const b=document.createElement('button'); b.className='primary'; b.textContent=d.toUpperCase(); b.onclick=()=>pick(d,b); wrap.appendChild(b); });
}
function paceRate(){
  const p = document.getElementById('pace').value;
  if(p==='slow') return 0; if(p==='fast') return 0.15; return 0.05;
}
function speakSequence(){
  if(!synth) return;
  playing=true; pos=0;
  let i=0;
  function step(){
    if(i>=seq.length){ playing=false; setTimeout(()=>say('Twoja kolej',0), 100); return; }
    const u = say(seq[i], paceRate());
    u.onend = () => { i++; setTimeout(step, 150); };
  }
  step();
}
function newRound(){
  seq.push(dirs[Math.floor(Math.random()*4)]);
  document.getElementById('len').textContent=seq.length;
  speakSequence();
}
function pick(d,b){
  if(playing) return;
  if(d===seq[pos]){ pos++; b.classList.add('good'); setTimeout(()=>b.classList.remove('good'),200); if(pos===seq.length){ ok++; document.getElementById('ok').textContent=ok; newRound(); } }
  else { err++; document.getElementById('err').textContent=err; b.classList.add('bad'); setTimeout(()=>b.classList.remove('bad'),200); pos=0; }
}
document.getElementById('start').onclick=()=>{ ok=0;err=0; seq=[dirs[Math.floor(Math.random()*4)]]; document.getElementById('ok').textContent='0'; document.getElementById('err').textContent='0'; buttons(); document.getElementById('len').textContent=seq.length; unlockTTS(); setTimeout(speakSequence, 120); };
document.getElementById('repeat').onclick=()=>{ if(seq.length) speakSequence(); };
document.getElementById('unlock').onclick=unlockTTS;
// Safari/iOS czasem pauzuje TTS po przejściu w tło – wznów po powrocie
document.addEventListener('visibilitychange', ()=>{ if(!synth) return; try{ synth.resume(); }catch(e){} });
</script>
</main></body></html>
